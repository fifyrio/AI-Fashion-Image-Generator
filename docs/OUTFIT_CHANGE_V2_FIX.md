# 模特换装V2 - 防止服装混合问题修复

## 问题描述

在使用"模特换装V2"功能时，特别是在"推荐搭配的裤子/上衣"场景下，出现了严重的服装混合问题：

### 典型问题
- **一半牛仔裤、一半瑜伽裤**：生成的图片中，裤子的上半部分是一种款式（如牛仔裤），下半部分却变成了另一种款式（如瑜伽裤）
- **原有服装与新服装混合**：第二张模特图的原有服装（如瑜伽裤）没有被完全替换，而是与第一张图的新服装（如牛仔裤）混合在一起
- **材质/颜色不统一**：同一件服装的不同部位出现不同的材质、颜色或款式

## 根本原因

AI 模型在换装时，可能会：
1. 保留第二张模特图的部分原有服装元素
2. 在替换服装时产生过渡区域的混合效果
3. 无法完全区分"完全替换"和"部分融合"的边界

## 解决方案

在 `lib/prompts.ts` 的 `OUTFIT_CHANGE_V2_PROMPT` 中添加了明确的防止服装混合规则。

### 修改位置

**文件**: `lib/prompts.ts`
**函数**: `OUTFIT_CHANGE_V2_PROMPT` (约第 463 行开始)

### 新增规则

#### 1. 在"完整的穿搭搭配"部分添加最高优先级规则

```
❗❗❗ **防止服装混合的最高优先级规则**：
- **绝对禁止出现一件服装混合两种不同款式的情况**
- **绝对禁止出现"一半牛仔裤、一半瑜伽裤"、"一半A裤子、一半B裤子"的混合效果**
- **绝对禁止在同一件下装上混合不同的材质、颜色、款式**
- **每件服装必须保持完整统一**：
  * 如果下装是牛仔裤，整条裤子从上到下都必须是牛仔裤
  * 如果下装是瑜伽裤，整条裤子从上到下都必须是瑜伽裤
  * 如果下装是裙子，整条裙子从上到下都必须保持同一款式
  * 不要让裤子的上半部分是一种款式，下半部分是另一种款式
- **第二张图的原有服装必须完全被替换**：
  * 如果第二张图的模特穿着瑜伽裤，换装后必须完全替换为第一张图的服装
  * 不要保留第二张图的任何原有服装元素
  * 不要让原有服装和新服装混合在一起
```

#### 2. 在"绝对禁止的操作"部分添加

```
- ❌❌❌ **严禁混合不同款式的服装**（如一半牛仔裤一半瑜伽裤）
- ❌❌❌ **严禁在同一件服装上出现多种材质、颜色、款式的混合**
- ❌❌❌ **严禁保留第二张图的原有服装元素与新服装混合**
- ❌ 不要让裤子的上半部分和下半部分是不同的款式
- ❌ 不要把第二张图的原有裤子和第一张图的新裤子混合在一起
```

#### 3. 在"正确做法"部分添加

```
- ✅✅✅ **服装完整性原则**：每件服装从头到尾必须是同一款式，绝不混合不同服装
- ✅✅✅ **完全替换原则**：第二张图的原有服装必须完全被第一张图的新服装替换
- ✅ 如果第一张图的下装是牛仔裤，整条裤子从腰部到脚踝都必须是牛仔裤
- ✅ 如果第一张图的下装是裙子，整条裙子从腰部到裙摆都必须是同一条裙子
- ✅ 完全移除第二张图模特的原有服装，用第一张图的服装完整替换
```

## 修改的关键点

### 1. 明确的禁止规则
- 使用三级警告标记（❌❌❌）强调最高优先级
- 明确列举具体的错误案例（如"一半牛仔裤、一半瑜伽裤"）
- 覆盖所有可能的混合情况

### 2. 清晰的正确示例
- 提供正面的指导原则
- 明确每种服装类型的正确处理方式
- 强调"完全替换"而非"部分融合"

### 3. 重复强化
- 在多个部分重复相同的规则
- 从不同角度描述同一个要求
- 确保 AI 模型充分理解并执行

## 测试建议

### 测试场景

1. **牛仔裤换装**
   - 第一张图：提取的牛仔裤（完整）
   - 第二张图：穿瑜伽裤的模特
   - 预期结果：整条裤子都是牛仔裤，没有瑜伽裤元素

2. **裙子换装**
   - 第一张图：提取的连衣裙
   - 第二张图：穿裤装的模特
   - 预期结果：完整的裙装，没有裤装元素

3. **全身搭配**
   - 第一张图：上衣+裤子的完整搭配
   - 第二张图：不同服装的模特
   - 预期结果：完整替换为新搭配，原服装完全消失

### 验证要点

- [ ] 裤子从腰部到脚踝是同一款式
- [ ] 裙子从腰部到裙摆是同一款式
- [ ] 没有原有服装的残留
- [ ] 材质、颜色、款式统一
- [ ] 没有过渡区域的混合效果

## 相关文件

- **Prompt 定义**: `lib/prompts.ts` (OUTFIT_CHANGE_V2_PROMPT)
- **服务实现**: `lib/kie-image-service.ts` (outfitChangeV2 方法)
- **API 端点**: `app/api/outfit-change-v2/route.ts`

## 其他改进

同时修复了画面构图问题：

### 问题
推荐搭配的全身服装（上衣+裤子）时，如果模特原图是半身照，生成的图片只显示半条裤子。

### 解决方案
修改了画面构图规则，当第一张图是**完整全身服装**时，自动调整为全身照展示：

```
**2. 画面构图和显示比例处理原则**：
- **全身服装特殊规则**：
  * ⚠️ **如果第一张图是完整的全身服装（包含上装+下装完整搭配）**：
    - 必须调整画面为**全身照**，完整展示整套服装
    - 不要裁剪下半身，必须显示裤子或裙子的完整长度
    - 画面应从头部到脚部完整展示模特穿着效果
```

## 预期效果

修改后，模特换装V2功能应该能够：

1. ✅ **完全避免服装混合**：每件服装保持完整统一
2. ✅ **完全替换原有服装**：不保留任何原服装元素
3. ✅ **展示完整搭配**：全身服装以全身照展示
4. ✅ **保持服装完整性**：从头到尾是同一款式

## 注意事项

1. **优先级**: 服装混合问题已设为最高优先级（❗❗❗、❌❌❌、✅✅✅）
2. **向后兼容**: 这些规则不影响现有的身材保持、头肩比例等核心功能
3. **性能影响**: 仅增加 prompt 内容，不影响 API 调用次数和响应时间

## 回滚方法

如果需要回滚此修改，移除 `lib/prompts.ts` 中以下标记的内容：
- "防止服装混合的最高优先级规则"部分
- 相关的 ❌❌❌ 和 ✅✅✅ 规则
- 画面构图特殊规则中的全身服装处理

---

**修改日期**: 2025-12-06
**修改原因**: 修复模特换装V2中出现的服装混合问题
**影响范围**: 所有使用 OUTFIT_CHANGE_V2_PROMPT 的换装功能
